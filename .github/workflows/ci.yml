name: CI (FisioFlow)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      # se você ainda não tem testes, deixe como comentário ou crie um teste simples
      - run: |
          echo "sem testes backend por enquanto" 
          # pytest -q

  test-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"
      - run: npm ci
      - run: |
          echo "sem testes frontend por enquanto"
          # npm test -- --ci

  build-backend:
    runs-on: ubuntu-latest
    needs: [test-backend]
    steps:
      - uses: actions/checkout@v4
      - name: Build backend image
        run: docker build -f backend/Dockerfile.prod -t fisioflow-backend:ci .

  build-frontend:
    runs-on: ubuntu-latest
    needs: [test-frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Build frontend image
        run: docker build -f frontend/Dockerfile.prod -t fisioflow-frontend:ci .

  # ====== Deploy opcional via Railway Action ======
  # Requer criar um token no Railway e salvar como secret: RAILWAY_TOKEN
  # E já ter conectado seu repo ao projeto no Railway (UI).
  # Descomente se quiser automatizar deploy a cada push na main.
  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: [build-backend, build-frontend]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Deploy to Railway
  #       uses: railwayapp/railway-action@v2
  #       with:
  #         # por padrão, ele faz deploy do projeto conectado
  #         service: ""  # deixe vazio para auto-detect; ou especifique se tiver múltiplos serviços
  #       env:
  #         RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}