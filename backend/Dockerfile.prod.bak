# ---- imagem base Python slim
FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# libs do sistema (psycopg2, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl ca-certificates libpq-dev gcc \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# requirements primeiro (cache melhor)
COPY backend/requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt \
    && pip install --no-cache-dir gunicorn

# copia app
COPY backend /app

# entrypoint (migrar + subir gunicorn)
COPY backend/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# porta padrão (Railway define $PORT em runtime)
ENV PORT=8080
EXPOSE 8080

# IMPORTANTe: o módulo "app:create_app()" pressupõe backend/app/__init__.py com create_app()
CMD ["/entrypoint.sh"]